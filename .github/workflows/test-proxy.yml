name: Test smart-git-proxy

on: [push, pull_request, workflow_dispatch]

jobs:
  test-proxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - run: make build

      - name: Start proxy
        run: |
          mkdir -p /tmp/git-mirrors
          MIRROR_DIR=/tmp/git-mirrors \
          LISTEN_ADDR=:8080 \
          AUTH_MODE=none \
          LOG_LEVEL=debug \
          ./bin/smart-git-proxy &
          sleep 2
          curl -f http://localhost:8080/healthz

      - name: Configure git to use proxy
        run: git config --global url."http://localhost:8080/github.com/".insteadOf "https://github.com/"

      - uses: actions/checkout@v6
        with:
          repository: runs-on/runs-on
          path: checkout1

      - run: |
          test -f checkout1/README.md
          echo "First checkout verified"

      - run: curl -s http://localhost:8080/metrics | grep smart_git_proxy

      - uses: actions/checkout@v6
        with:
          repository: runs-on/runs-on
          path: checkout2

      - run: |
          test -f checkout2/README.md
          echo "Second checkout verified"

      - name: Verify mirror exists
        run: |
          echo "--- Checking mirror ---"
          ls -la /tmp/git-mirrors/github.com/runs-on/
          test -d /tmp/git-mirrors/github.com/runs-on/runs-on.git
          echo "SUCCESS: Mirror exists!"

      - name: Verify metrics
        run: |
          curl -s http://localhost:8080/metrics | tee /tmp/metrics.txt
          echo "--- Request metrics ---"
          grep -E "smart_git_proxy_requests_total" /tmp/metrics.txt
          if grep -q 'smart_git_proxy_requests_total.*[1-9]' /tmp/metrics.txt; then
            echo "SUCCESS: Requests recorded!"
          else
            echo "WARNING: No requests found"
            exit 1
          fi
